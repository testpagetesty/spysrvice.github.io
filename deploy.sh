#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ Beget VPS
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash deploy.sh

set -e

echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ Beget VPS"
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js..."
if ! command -v node &> /dev/null; then
    echo -e "${RED}‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20 LTS..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt install -y nodejs
else
    echo -e "${GREEN}‚úÖ Node.js —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(node --version)${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PostgreSQL
echo ""
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ PostgreSQL..."
if ! command -v psql &> /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  PostgreSQL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL..."
    apt update
    apt install -y postgresql postgresql-contrib
    systemctl start postgresql
    systemctl enable postgresql
else
    echo -e "${GREEN}‚úÖ PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2
echo ""
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2..."
if ! command -v pm2 &> /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
    npm install -g pm2
else
    echo -e "${GREEN}‚úÖ PM2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
echo ""
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞..."
npm install

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
echo ""
echo "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ ! -f .env.production ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env.production –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.example"
    echo "–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: cp .env.example .env.production"
    exit 1
else
    echo -e "${GREEN}‚úÖ –§–∞–π–ª .env.production –Ω–∞–π–¥–µ–Ω${NC}"
fi

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo ""
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤ PM2
echo ""
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤..."
mkdir -p /var/log/pm2

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2..."
if pm2 list | grep -q "spy-dashboard"; then
    echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."
    pm2 restart spy-dashboard
else
    pm2 start ecosystem.config.js
fi

pm2 save

echo ""
echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: pm2 status"
echo "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: pm2 logs spy-dashboard"
echo ""

